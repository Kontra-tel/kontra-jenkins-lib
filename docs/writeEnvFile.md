# writeEnvFile

Generate and install environment files with automatic formatting and permissions management.

## Overview

`writeEnvFile` creates properly formatted environment files (`.env` style) from environment variables or custom data, with automatic quoting, escaping, and permission management.

**Key Features:**
- Automatic key sanitization (uppercase, alphanumeric + underscore)
- Proper value quoting and escaping
- Multi-line value support
- Customizable file permissions (mode, owner, group)
- Dry-run mode for testing
- Atomic file installation
- Auto-generated timestamps

## Basic Usage

```groovy
@Library('kontra-jenkins-lib') _

pipeline {
    agent any
    stages {
        stage('Configure') {
            steps {
                script {
                    writeEnvFile(
                        path: '/opt/my-app/.env',
                        data: [
                            DATABASE_URL: 'postgresql://localhost/mydb',
                            API_KEY: env.API_SECRET,
                            DEBUG: 'true'
                        ]
                    )
                }
            }
        }
    }
}
```

## Parameters

### Required
- `path` (String) - Target path for environment file (e.g., `'/opt/app/.env'`)

### Data Sources
- `data` (Map) - Key-value pairs to write (optional, can use `keys` + env vars instead)
- `keys` (List or String) - Environment variable names to include
  - Can be List: `['VAR1', 'VAR2']`
  - Can be String: `'VAR1,VAR2'` or `'VAR1 VAR2'`
  - If not provided and `data` is empty, includes all `data` keys

### File Options
- `header` (String) - File header comment (default: auto-generated timestamp)
- `mode` (String) - File permissions (default: `'600'`)
- `owner` (String) - File owner (optional, requires sudo)
- `group` (String) - File group (optional, requires sudo)
- `useSudo` (Boolean) - Use sudo for installation (default: `true`)

### Formatting
- `sortKeys` (Boolean) - Sort keys alphabetically (default: `true`)

### Testing
- `dryRun` (Boolean) - Test mode, doesn't install file (default: `false`)

## Examples

### Basic Environment File

```groovy
stage('Setup Environment') {
    steps {
        script {
            writeEnvFile(
                path: '/opt/app/.env',
                data: [
                    PORT: '8080',
                    HOST: '0.0.0.0',
                    LOG_LEVEL: 'info'
                ]
            )
        }
    }
}
```

**Generated file:**
```bash
# Autogenerated by Jenkins on 2024-01-15 10:30:00 UTC (http://jenkins.local)
HOST="0.0.0.0"
LOG_LEVEL="info"
PORT="8080"
```

### Using Environment Variables

```groovy
stage('Setup Environment') {
    steps {
        script {
            // Set environment variables
            env.DATABASE_URL = 'postgresql://localhost/mydb'
            env.API_KEY = credentials('api-key')
            
            // Write only specific env vars
            writeEnvFile(
                path: '/opt/app/.env',
                keys: ['DATABASE_URL', 'API_KEY'],
                data: [:]  // Empty data, uses env vars
            )
        }
    }
}
```

### Custom Permissions and Owner

```groovy
stage('Setup Environment') {
    steps {
        script {
            writeEnvFile(
                path: '/etc/myapp/config.env',
                data: [
                    SERVICE_NAME: 'my-app',
                    CONFIG_PATH: '/etc/myapp'
                ],
                mode: '640',
                owner: 'myapp',
                group: 'myapp',
                useSudo: true
            )
        }
    }
}
```

### Custom Header

```groovy
stage('Setup Environment') {
    steps {
        script {
            writeEnvFile(
                path: '/opt/app/.env',
                data: [
                    VERSION: env.BUILD_VERSION,
                    BUILD_NUMBER: env.BUILD_NUMBER
                ],
                header: '''# My Application Configuration
# Generated by CI/CD Pipeline
# DO NOT EDIT MANUALLY'''
            )
        }
    }
}
```

### Dry Run (Testing)

```groovy
stage('Test Configuration') {
    steps {
        script {
            def result = writeEnvFile(
                path: '/opt/app/.env',
                data: [
                    TEST_VAR: 'test_value'
                ],
                dryRun: true
            )
            
            echo "Dry run result:"
            echo "Would write to: ${result.path}"
            echo "Keys: ${result.keys}"
            echo "Content:\n${result.content}"
        }
    }
}
```

### Multi-line Values

```groovy
stage('Setup Environment') {
    steps {
        script {
            writeEnvFile(
                path: '/opt/app/.env',
                data: [
                    PRIVATE_KEY: '''-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
-----END PRIVATE KEY-----''',
                    CONFIG_JSON: '{"key": "value", "nested": {"data": "here"}}'
                ]
            )
        }
    }
}
```

**Generated file:**
```bash
# Autogenerated by Jenkins on 2024-01-15 10:30:00 UTC
CONFIG_JSON="{\"key\": \"value\", \"nested\": {\"data\": \"here\"}}"
PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...\n-----END PRIVATE KEY-----"
```

### Mixed Keys (List, Comma-separated, Space-separated)

```groovy
// All these are equivalent:

// List format
writeEnvFile(path: '/opt/app/.env', keys: ['VAR1', 'VAR2', 'VAR3'])

// Comma-separated
writeEnvFile(path: '/opt/app/.env', keys: 'VAR1,VAR2,VAR3')

// Space-separated
writeEnvFile(path: '/opt/app/.env', keys: 'VAR1 VAR2 VAR3')
```

### Unsorted Keys

```groovy
stage('Setup Environment') {
    steps {
        script {
            writeEnvFile(
                path: '/opt/app/.env',
                data: [
                    ZEBRA: 'last',
                    ALPHA: 'first',
                    BETA: 'middle'
                ],
                sortKeys: false  // Preserve order
            )
        }
    }
}
```

## Key Sanitization

Keys are automatically sanitized to be valid environment variable names:

- Converted to uppercase
- Non-alphanumeric characters replaced with underscore
- Only `A-Z`, `0-9`, and `_` allowed

**Examples:**
- `my-var` → `MY_VAR`
- `api.key` → `API_KEY`
- `some@weird#key` → `SOME_WEIRD_KEY`

## Value Escaping

Values are properly escaped for shell environments:

- Wrapped in double quotes
- Backslashes escaped: `\` → `\\`
- Double quotes escaped: `"` → `\"`
- Newlines folded: `\n` → `\\n`
- Null values converted to empty strings

## Return Value

Returns a map with:

```groovy
[
    dryRun: false,              // Whether this was a dry run
    path: '/opt/app/.env',      // Target file path
    keys: ['KEY1', 'KEY2'],     // Keys written
    content: "KEY1=\"value1\"\nKEY2=\"value2\"\n"  // Full content
]
```

## Integration with deploySystemd

Commonly used with `deploySystemd` to create service environment files:

```groovy
@Library('kontra-jenkins-lib') _

pipeline {
    agent any
    stages {
        stage('Create Config') {
            steps {
                script {
                    // Create environment file
                    writeEnvFile(
                        path: '/opt/my-app/.env',
                        data: [
                            PORT: '8080',
                            DATABASE_URL: env.DATABASE_URL,
                            LOG_LEVEL: 'info'
                        ],
                        mode: '600',
                        owner: 'my-app',
                        group: 'my-app'
                    )
                }
            }
        }
        
        stage('Deploy Service') {
            steps {
                deploySystemd(
                    service: 'my-app',
                    envFile: '/opt/my-app/.env',  // Reference the env file
                    artifactGlob: 'build/libs/*.jar',
                    workingDir: '/opt/my-app'
                )
            }
        }
    }
}
```

## Best Practices

1. **Secure Credentials** - Use Jenkins credentials, never hardcode secrets
2. **Restrict Permissions** - Use `mode: '600'` or `'640'` for sensitive files
3. **Set Owner/Group** - Match the service user for security
4. **Use Dry Run** - Test configuration before deploying
5. **Sort Keys** - Keep sorted for easier diffing and debugging
6. **Custom Headers** - Add warnings for generated files

## Security Considerations

1. **File Permissions**: Default `600` (owner read/write only)
2. **Atomic Installation**: Uses `install` command for atomic writes
3. **Sudo Usage**: Only when needed (owner/group changes)
4. **Credential Handling**: Values are escaped, but still visible in logs
5. **Temporary Files**: Cleaned up after installation

## Troubleshooting

### Permission Denied

**Problem:** "Permission denied" when writing file

**Solutions:**
- Check `useSudo: true` if writing to system paths
- Verify Jenkins user has write access to directory
- Ensure directory exists (create with `sh 'mkdir -p /opt/app'`)

### Owner/Group Not Set

**Problem:** File created but owner/group unchanged

**Solutions:**
- Ensure `useSudo: true` when setting owner/group
- Verify user/group exist on system
- Check sudoers configuration allows `install` command

### Values Not Escaped

**Problem:** Values with special characters break file

**Solutions:**
- Check value contains backslashes or quotes
- Verify escaping is working (inspect `result.content` in dry run)
- Report as bug if proper escaping fails

### Keys Not Sorted

**Problem:** Keys appear in random order

**Solutions:**
- Check `sortKeys: true` (default)
- Note: Map iteration order may vary in Groovy
- Use `sortKeys: false` to preserve data map order

## See Also

- [deploySystemd](deploySystemd.md) - Uses writeEnvFile for service configuration
- [semver](semver.md) - Can write version to env files
